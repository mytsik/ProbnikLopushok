CREATE TABLE public."Agent"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Title" varchar(150) NOT NULL,
	"AgentTypeID" int4 NOT NULL,
	"Address" varchar(300) NULL,
	"INN" varchar(12) NOT NULL,
	"KPP" varchar(9) NULL,
	"DirectorName" varchar(100) NULL,
	"Phone" varchar(20) NOT NULL,
	"Email" varchar(255) NULL,
	"Logo" varchar(100) NULL,
	"Priority" int4 NOT NULL,
	CONSTRAINT "PK_Agent" PRIMARY KEY ("ID"));


CREATE TABLE public."AgentPriorityHistory"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"AgentID" int4 NOT NULL,
	"ChangeDate" timestamp NOT NULL,
	"PriorityValue" int4 NOT NULL,
	CONSTRAINT "PK_AgentPriorityHistory" PRIMARY KEY ("ID")
);

CREATE TABLE public."AgentType"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Title" varchar(50) NOT NULL,
	"Image" varchar(100) NULL,
	CONSTRAINT "PK_AgentType" PRIMARY KEY ("ID")
);

CREATE TABLE public."Material"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Title" varchar(100) NOT NULL,
	"CountInPack" int4 NOT NULL,
	"Unit" varchar(10) NOT NULL,
	"CountInStock" float NULL,
	"MinCount" float NOT NULL,
	"Description" text NULL,
	"Cost" numeric(10, 2) NOT NULL,
	"Image" varchar(100) NULL,
	"MaterialTypeID" int4 NOT NULL,
	CONSTRAINT "PK_Material" PRIMARY KEY ("ID")
);

CREATE TABLE public."MaterialCountHistory"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"MaterialID" int4 NOT NULL,
	"ChangeDate" timestamp NOT NULL,
	"CountValue" float NOT NULL,
	CONSTRAINT "PK_MaterialCountHistory" PRIMARY KEY ("ID")
);

CREATE TABLE public."MaterialSupplier"(
	"MaterialID" int4 NOT NULL,
	"SupplierID" int4 NOT NULL,
 CONSTRAINT "PK_MaterialSupplier" PRIMARY KEY ("MaterialID", "SupplierID")
);

CREATE TABLE public."MaterialType"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Title" varchar(50) NOT NULL,
	"DefectedPercent" float NOT NULL,
	CONSTRAINT "PK_MaterialType" PRIMARY KEY ("ID"));

CREATE TABLE public."Product"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Title" varchar(100) NOT NULL,
	"ProductTypeID" int4 NULL,
	"ArticleNumber" varchar(10) NOT NULL,
	"Description" text NULL,
	"Image" varchar(100) NULL,
	"ProductionPersonCount" int4 NULL,
	"ProductionWorkshopNumber" int4 NULL,
	"MinCostForAgent" numeric(10, 2) NOT NULL,
	CONSTRAINT "PK_Product" PRIMARY KEY ("ID"));

CREATE TABLE public."ProductCostHistory"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"ProductID" int4 NOT NULL,
	"ChangeDate" timestamp NOT NULL,
	"CostValue" decimal(10, 2) NOT NULL,
 CONSTRAINT "PK_ProductCostHistory" PRIMARY KEY ("ID")
);

CREATE TABLE public."ProductMaterial"(
	"ProductID" int4 NOT NULL,
	"MaterialID" int4 NOT NULL,
	"MaterialTitle" varchar NOT NULL,
	"ProductTitle" varchar NOT NULL,
	"Count" float NULL,
	CONSTRAINT "PK_ProductMaterial" PRIMARY KEY ("ProductID", "MaterialID")
);

CREATE TABLE public."ProductSale"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"AgentID" int4 NOT NULL,
	"ProductID" int4 NOT NULL,
	"SaleDate" timestamp NOT NULL,
	"ProductCount" int4 NOT NULL,
 CONSTRAINT "PK_ProductSale" PRIMARY KEY ("ID")
);

CREATE TABLE public."ProductType"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Title" varchar(50) NOT NULL,
	"DefectedPercent" float NOT NULL,
 CONSTRAINT "PK_ProductType" PRIMARY KEY ("ID")
);

CREATE TABLE public."Shop"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Title" varchar(150) NOT NULL,
	"Address" varchar(300) NULL,
	"AgentID" int4 NOT NULL,
 CONSTRAINT "PK_Shop" PRIMARY KEY ("ID")
);

CREATE TABLE public."Supplier"(
	"ID" int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"Title" varchar(150) NOT NULL,
	"INN" varchar(12) NOT NULL,
	"StartDate" timestamp NOT NULL,
	"QualityRating" int4 NULL,
	"SupplierType" varchar(20) NULL,
 CONSTRAINT "PK_Supplier" PRIMARY KEY ("ID")
);


ALTER TABLE public."Agent" ADD CONSTRAINT "FK_Agent_AgentType" FOREIGN KEY("AgentTypeID") REFERENCES public."AgentType" ("ID");

ALTER TABLE public."AgentPriorityHistory" ADD CONSTRAINT "FK_AgentPriorityHistory_Agent" FOREIGN KEY("AgentID") 
REFERENCES public."Agent" ("ID");

ALTER TABLE public."Material" ADD CONSTRAINT "FK_Material_MaterialType" FOREIGN KEY("MaterialTypeID")
REFERENCES public."MaterialType" ("ID");

ALTER TABLE public."MaterialCountHistory" ADD CONSTRAINT "FK_MaterialCountHistory_Material" FOREIGN KEY("MaterialID")
REFERENCES public."Material" ("ID");

ALTER TABLE public."MaterialSupplier" ADD CONSTRAINT "FK_MaterialSupplier_Material" FOREIGN KEY("MaterialID")
REFERENCES public."Material" ("ID");

ALTER TABLE public."MaterialSupplier" ADD CONSTRAINT "FK_MaterialSupplier_Supplier" FOREIGN KEY("SupplierID")
REFERENCES public."Supplier" ("ID");

ALTER TABLE public."Product" ADD CONSTRAINT "FK_Product_ProductType" FOREIGN KEY("ProductTypeID")
REFERENCES public."ProductType" ("ID");

ALTER TABLE public."ProductCostHistory" ADD CONSTRAINT "FK_ProductCostHistory_Product" FOREIGN KEY("ProductID")
REFERENCES public."Product" ("ID");

ALTER TABLE public."ProductMaterial" ADD CONSTRAINT "FK_ProductMaterial_Material" FOREIGN KEY("MaterialID")
REFERENCES public."Material" ("ID");

ALTER TABLE public."ProductMaterial" ADD CONSTRAINT "FK_ProductMaterial_Product" FOREIGN KEY("ProductID")
REFERENCES public."Product" ("ID");

ALTER TABLE public."ProductSale" ADD CONSTRAINT "FK_ProductSale_Agent" FOREIGN KEY("AgentID")
REFERENCES public."Agent" ("ID");

ALTER TABLE public."ProductSale" ADD CONSTRAINT "FK_ProductSale_Product" FOREIGN KEY("ProductID")
REFERENCES public."Product" ("ID");

ALTER TABLE public."Shop" ADD CONSTRAINT "FK_Shop_Agent" FOREIGN KEY("AgentID")
REFERENCES public."Agent" ("ID");

COPY public."MaterialType" FROM 'C:/ImportCSVFiles/MyMaterialType.csv' DELIMITER ';'CSV HEADER;
COPY public."Material" FROM 'C:/ImportCSVFiles/MyMaterial.csv' DELIMITER ';'CSV HEADER;
COPY public."ProductType" FROM 'C:/ImportCSVFiles/MyProductType.csv' DELIMITER ';'CSV HEADER;
COPY public."Product" FROM 'C:/ImportCSVFiles/MyProduct.csv' DELIMITER ';'CSV HEADER;
COPY public."ProductMaterial" FROM 'C:/ImportCSVFiles/MyProductMaterial.csv' DELIMITER ';'CSV HEADER;

UPDATE public."ProductMaterial" 
SET "MaterialID" = public."Material"."ID","ProductID" = public."Product"."ID" 
FROM public."Material", public."Product" 
WHERE public."Material"."Title" = public."ProductMaterial"."MaterialTitle"
AND public."Product"."Title" = public."ProductMaterial"."ProductTitle";

ALTER TABLE public."ProductMaterial"
DROP COLUMN "ProductTitle";

ALTER TABLE public."ProductMaterial"
DROP COLUMN "MaterialTitle";
